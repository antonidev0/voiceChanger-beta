<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VoxShift ‚Äî Cambia tu Voz</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Exo+2:wght@300;400;600&display=swap');

  :root {
    --bg: #0a0a12;
    --surface: #12121f;
    --surface2: #1a1a2e;
    --accent: #7c3aff;
    --accent2: #ff3a7c;
    --accent3: #3affd0;
    --text: #e8e8ff;
    --muted: #6060a0;
    --glow: rgba(124, 58, 255, 0.4);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Exo 2', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
    position: relative;
  }

  /* Animated background grid */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(124,58,255,0.05) 1px, transparent 1px),
      linear-gradient(90deg, rgba(124,58,255,0.05) 1px, transparent 1px);
    background-size: 40px 40px;
    animation: gridMove 20s linear infinite;
    pointer-events: none;
  }

  @keyframes gridMove {
    0% { transform: translateY(0); }
    100% { transform: translateY(40px); }
  }

  /* Floating orbs */
  .orb {
    position: fixed;
    border-radius: 50%;
    filter: blur(80px);
    pointer-events: none;
    opacity: 0.15;
    animation: orbFloat 8s ease-in-out infinite;
  }
  .orb1 { width: 400px; height: 400px; background: var(--accent); top: -100px; left: -100px; }
  .orb2 { width: 300px; height: 300px; background: var(--accent2); bottom: -50px; right: -50px; animation-delay: -4s; }
  .orb3 { width: 200px; height: 200px; background: var(--accent3); top: 50%; left: 50%; animation-delay: -2s; }

  @keyframes orbFloat {
    0%, 100% { transform: translate(0, 0) scale(1); }
    50% { transform: translate(20px, -30px) scale(1.1); }
  }

  .container {
    max-width: 960px;
    margin: 0 auto;
    padding: 40px 20px;
    position: relative;
    z-index: 1;
  }

  header {
    text-align: center;
    margin-bottom: 50px;
  }

  header h1 {
    font-family: 'Orbitron', sans-serif;
    font-size: clamp(2rem, 6vw, 3.5rem);
    font-weight: 900;
    background: linear-gradient(135deg, var(--accent), var(--accent2), var(--accent3));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    letter-spacing: 4px;
    line-height: 1.1;
    text-shadow: none;
    position: relative;
  }

  header p {
    color: var(--muted);
    margin-top: 10px;
    font-size: 1rem;
    letter-spacing: 2px;
    text-transform: uppercase;
  }

  /* Character Grid */
  .section-title {
    font-family: 'Orbitron', sans-serif;
    font-size: 0.75rem;
    letter-spacing: 4px;
    text-transform: uppercase;
    color: var(--accent3);
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .section-title::after {
    content: '';
    flex: 1;
    height: 1px;
    background: linear-gradient(90deg, var(--accent3), transparent);
  }

  .characters-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
    gap: 16px;
    margin-bottom: 40px;
  }

  .character-card {
    background: var(--surface);
    border: 1px solid rgba(124,58,255,0.2);
    border-radius: 16px;
    padding: 20px 12px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    position: relative;
    overflow: hidden;
    user-select: none;
  }

  .character-card::before {
    content: '';
    position: absolute;
    inset: 0;
    background: radial-gradient(circle at 50% 0%, rgba(124,58,255,0.15), transparent 70%);
    opacity: 0;
    transition: opacity 0.3s;
  }

  .character-card:hover { transform: translateY(-4px) scale(1.03); border-color: var(--accent); }
  .character-card:hover::before { opacity: 1; }

  .character-card.active {
    border-color: var(--accent);
    background: rgba(124,58,255,0.15);
    box-shadow: 0 0 30px rgba(124,58,255,0.4), inset 0 0 20px rgba(124,58,255,0.1);
    transform: translateY(-4px) scale(1.05);
  }
  .character-card.active::before { opacity: 1; }

  .char-emoji {
    font-size: 2.5rem;
    display: block;
    margin-bottom: 10px;
    filter: drop-shadow(0 0 8px rgba(255,255,255,0.3));
    transition: transform 0.3s;
  }
  .character-card:hover .char-emoji { transform: scale(1.15) rotate(-5deg); }
  .character-card.active .char-emoji { animation: bounce 0.5s ease; }

  @keyframes bounce {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.3) rotate(10deg); }
  }

  .char-name {
    font-family: 'Orbitron', sans-serif;
    font-size: 0.6rem;
    letter-spacing: 1px;
    text-transform: uppercase;
    color: var(--text);
    opacity: 0.8;
  }
  .character-card.active .char-name { color: var(--accent3); opacity: 1; }

  .char-tag {
    font-size: 0.55rem;
    color: var(--muted);
    margin-top: 4px;
    display: block;
    
  }

  /* Active indicator */
  .active-indicator {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 8px;
    height: 8px;
    background: var(--accent3);
    border-radius: 50%;
    opacity: 0;
    box-shadow: 0 0 8px var(--accent3);
  }
  .character-card.active .active-indicator {
    opacity: 1;
    animation: pulse 1.5s ease-in-out infinite;
  }
  @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.5); } }

  /* Controls Panel */
  .controls-panel {
    background: var(--surface);
    border: 1px solid rgba(124,58,255,0.2);
    border-radius: 24px;
    padding: 32px;
    margin-bottom: 32px;
    position: relative;
    overflow: hidden;
  }
  .controls-panel::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--accent), transparent);
  }

  .controls-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
    margin-bottom: 28px;
  }

  @media (max-width: 500px) { .controls-row { grid-template-columns: 1fr; } }

  .control-group label {
    display: block;
    font-family: 'Orbitron', sans-serif;
    font-size: 0.6rem;
    letter-spacing: 3px;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 10px;
  }

  .control-group .value-display {
    float: right;
    color: var(--accent3);
    font-family: 'Orbitron', sans-serif;
  }

  input[type=range] {
    -webkit-appearance: none;
    width: 100%;
    height: 4px;
    background: var(--surface2);
    border-radius: 2px;
    outline: none;
    cursor: pointer;
  }
  input[type=range]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 18px;
    height: 18px;
    background: var(--accent);
    border-radius: 50%;
    cursor: pointer;
    box-shadow: 0 0 12px var(--glow);
    transition: transform 0.2s, box-shadow 0.2s;
  }
  input[type=range]::-webkit-slider-thumb:hover {
    transform: scale(1.3);
    box-shadow: 0 0 20px var(--glow);
  }
  input[type=range]::-webkit-slider-runnable-track {
    background: linear-gradient(90deg, var(--accent) var(--progress, 50%), var(--surface2) var(--progress, 50%));
    border-radius: 2px;
  }

  /* Record Button */
  .record-section {
    text-align: center;
  }

  .record-btn {
    position: relative;
    width: 100px;
    height: 100px;
    border-radius: 50%;
    border: 3px solid var(--accent);
    background: transparent;
    cursor: pointer;
    transition: all 0.3s;
    margin: 0 auto 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    outline: none;
    box-shadow: 0 0 0 0 var(--glow);
  }
  .record-btn::before {
    content: '';
    position: absolute;
    inset: -8px;
    border-radius: 50%;
    border: 1px solid rgba(124,58,255,0.3);
  }
  .record-btn::after {
    content: '';
    position: absolute;
    inset: -16px;
    border-radius: 50%;
    border: 1px solid rgba(124,58,255,0.15);
  }
  .record-btn:hover {
    background: rgba(124,58,255,0.15);
    box-shadow: 0 0 40px rgba(124,58,255,0.5);
    transform: scale(1.05);
  }
  .record-btn.recording {
    border-color: var(--accent2);
    background: rgba(255,58,124,0.1);
    animation: recordPulse 1.5s ease-in-out infinite;
    box-shadow: 0 0 40px rgba(255,58,124,0.5);
  }
  @keyframes recordPulse {
    0%, 100% { box-shadow: 0 0 20px rgba(255,58,124,0.3), 0 0 0 0 rgba(255,58,124,0.4); }
    50% { box-shadow: 0 0 40px rgba(255,58,124,0.6), 0 0 0 20px rgba(255,58,124,0); }
  }

  .record-status {
    font-family: 'Orbitron', sans-serif;
    font-size: 0.7rem;
    letter-spacing: 3px;
    text-transform: uppercase;
    color: var(--muted);
    transition: color 0.3s;
  }
  .record-status.active { color: var(--accent2); }

  /* Visualizer */
  .visualizer-container {
    background: var(--surface2);
    border-radius: 12px;
    padding: 16px;
    margin: 24px 0;
    height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    border: 1px solid rgba(124,58,255,0.1);
  }

  #visualizer {
    width: 100%;
    height: 100%;
  }

  /* Playback Section */
  .playback-section {
    background: var(--surface);
    border: 1px solid rgba(124,58,255,0.2);
    border-radius: 24px;
    padding: 28px;
    position: relative;
    overflow: hidden;
  }
  .playback-section::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--accent2), transparent);
  }

  .no-recording {
    text-align: center;
    color: var(--muted);
    font-size: 0.85rem;
    letter-spacing: 1px;
    padding: 20px;
  }

  .recording-item {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 16px;
    background: var(--surface2);
    border-radius: 12px;
    border: 1px solid rgba(124,58,255,0.15);
    margin-bottom: 12px;
    animation: slideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
  }
  @keyframes slideIn {
    from { opacity: 0; transform: translateX(-20px) scale(0.95); }
    to { opacity: 1; transform: translateX(0) scale(1); }
  }

  .recording-info { flex: 1; min-width: 0; }
  .recording-name {
    font-family: 'Orbitron', sans-serif;
    font-size: 0.7rem;
    letter-spacing: 2px;
    color: var(--text);
    margin-bottom: 4px;
  }
  .recording-char { font-size: 0.7rem; color: var(--accent3); }

  .play-btn {
    background: rgba(124,58,255,0.2);
    border: 1px solid var(--accent);
    border-radius: 8px;
    color: var(--text);
    padding: 8px 16px;
    cursor: pointer;
    font-family: 'Orbitron', sans-serif;
    font-size: 0.6rem;
    letter-spacing: 2px;
    text-transform: uppercase;
    transition: all 0.2s;
  }
  .play-btn:hover { background: rgba(124,58,255,0.4); box-shadow: 0 0 15px rgba(124,58,255,0.4); }

  .del-btn {
    background: rgba(255,58,124,0.1);
    border: 1px solid rgba(255,58,124,0.3);
    border-radius: 8px;
    color: var(--accent2);
    padding: 8px 12px;
    cursor: pointer;
    font-size: 0.8rem;
    transition: all 0.2s;
  }
  .del-btn:hover { background: rgba(255,58,124,0.3); }

  .dl-btn {
    background: rgba(58,255,208,0.1);
    border: 1px solid rgba(58,255,208,0.3);
    border-radius: 8px;
    color: var(--accent3);
    padding: 8px 12px;
    cursor: pointer;
    font-size: 0.8rem;
    transition: all 0.2s;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
  }
  .dl-btn:hover { background: rgba(58,255,208,0.3); }

  /* Info banner */
  .info-banner {
    background: rgba(58,255,208,0.07);
    border: 1px solid rgba(58,255,208,0.2);
    border-radius: 12px;
    padding: 14px 20px;
    margin-bottom: 24px;
    font-size: 0.8rem;
    color: var(--accent3);
    line-height: 1.6;
  }

  /* Current character display */
  .current-char {
    display: flex;
    align-items: center;
    gap: 12px;
    background: rgba(124,58,255,0.1);
    border: 1px solid rgba(124,58,255,0.3);
    border-radius: 12px;
    padding: 12px 20px;
    margin-bottom: 20px;
  }
  .current-char-emoji { font-size: 1.8rem; }
  .current-char-info { flex: 1; }
  .current-char-label {
    font-family: 'Orbitron', sans-serif;
    font-size: 0.55rem;
    letter-spacing: 3px;
    color: var(--muted);
    text-transform: uppercase;
  }
  .current-char-name {
    font-family: 'Orbitron', sans-serif;
    font-size: 0.85rem;
    color: var(--accent3);
    margin-top: 2px;
  }

  .badge {
    background: rgba(124,58,255,0.3);
    border: 1px solid var(--accent);
    border-radius: 20px;
    padding: 4px 12px;
    font-family: 'Orbitron', sans-serif;
    font-size: 0.55rem;
    letter-spacing: 2px;
    color: var(--accent3);
    text-transform: uppercase;
  }

  .separator {
    height: 1px;
    background: linear-gradient(90deg, transparent, rgba(124,58,255,0.3), transparent);
    margin: 32px 0;
  }

  /* Custom char input */
  .custom-char-section {
    margin-bottom: 32px;
  }

  .input-row {
    display: flex;
    gap: 12px;
    margin-top: 16px;
  }

  .custom-input {
    flex: 1;
    background: var(--surface2);
    border: 1px solid rgba(124,58,255,0.3);
    border-radius: 12px;
    padding: 12px 16px;
    color: var(--text);
    font-family: 'Exo 2', sans-serif;
    font-size: 0.9rem;
    outline: none;
    transition: border-color 0.2s;
  }
  .custom-input:focus { border-color: var(--accent); }
  .custom-input::placeholder { color: var(--muted); }

  .emoji-input {
    width: 70px;
    text-align: center;
    font-size: 1.4rem;
  }

  .add-btn {
    background: rgba(124,58,255,0.2);
    border: 1px solid var(--accent);
    border-radius: 12px;
    color: var(--text);
    padding: 12px 20px;
    cursor: pointer;
    font-family: 'Orbitron', sans-serif;
    font-size: 0.6rem;
    letter-spacing: 2px;
    text-transform: uppercase;
    transition: all 0.2s;
    white-space: nowrap;
  }
  .add-btn:hover { background: rgba(124,58,255,0.5); box-shadow: 0 0 20px rgba(124,58,255,0.4); }
</style>
</head>
<body>

<div class="orb orb1"></div>
<div class="orb orb2"></div>
<div class="orb orb3"></div>

<div class="container">

  <header>
    <h1>VOXSHIFT</h1>
    <p>Cambia tu voz ¬∑ Elige tu personaje</p>
  </header>

  <div class="info-banner">
    üéôÔ∏è <strong>C√≥mo funciona:</strong> Selecciona un personaje, ajusta los par√°metros y presiona Grabar. La app procesa tu voz en tiempo real aplicando efectos de pitch, reverb, distorsi√≥n y m√°s para transformar tu voz al personaje elegido. Descarga el resultado en formato .webm.
  </div>

  <!-- Character Selection -->
  <div class="section-title">Elige tu personaje</div>
  <div class="characters-grid" id="characters-grid"></div>

  <!-- Custom Character -->
  <div class="custom-char-section">
    <div class="section-title">Personaje personalizado</div>
    <div class="input-row">
      <input type="text" class="custom-input emoji-input" id="custom-emoji" placeholder="ü¶∏" maxlength="2">
      <input type="text" class="custom-input" id="custom-name" placeholder="Nombre del personaje (ej. Gandalf)">
      <button class="add-btn" onclick="addCustomCharacter()">+ A√±adir</button>
    </div>
  </div>

  <div class="separator"></div>

  <!-- Controls -->
  <div class="section-title">Par√°metros de voz</div>
  <div class="controls-panel">

    <div class="current-char" id="current-char-display">
      <div class="current-char-emoji">üé≠</div>
      <div class="current-char-info">
        <div class="current-char-label">Personaje activo</div>
        <div class="current-char-name" id="current-char-name">Sin seleccionar</div>
      </div>
      <div class="badge">SELECCIONA</div>
    </div>

    <div class="controls-row">
      <div class="control-group">
        <label>Pitch (tono) <span class="value-display" id="pitch-val">0</span></label>
        <input type="range" id="pitch" min="-12" max="12" value="0" step="0.5" oninput="updateSlider(this,'pitch-val')">
      </div>
      <div class="control-group">
        <label>Velocidad <span class="value-display" id="speed-val">1.0x</span></label>
        <input type="range" id="speed" min="0.5" max="2.0" value="1.0" step="0.05" oninput="updateSlider(this,'speed-val',true)">
      </div>
      <div class="control-group">
        <label>Reverb / Eco <span class="value-display" id="reverb-val">0%</span></label>
        <input type="range" id="reverb" min="0" max="100" value="0" oninput="updateSlider(this,'reverb-val',false,true)">
      </div>
      <div class="control-group">
        <label>Distorsi√≥n <span class="value-display" id="distortion-val">0%</span></label>
        <input type="range" id="distortion" min="0" max="100" value="0" oninput="updateSlider(this,'distortion-val',false,true)">
      </div>
      <div class="control-group">
        <label>Graves (Bass) <span class="value-display" id="bass-val">0dB</span></label>
        <input type="range" id="bass" min="-20" max="20" value="0" oninput="updateSlider(this,'bass-val',false,false,true)">
      </div>
      <div class="control-group">
        <label>Agudos (Treble) <span class="value-display" id="treble-val">0dB</span></label>
        <input type="range" id="treble" min="-20" max="20" value="0" oninput="updateSlider(this,'treble-val',false,false,true)">
      </div>
    </div>

    <!-- Visualizer -->
    <div class="visualizer-container">
      <canvas id="visualizer"></canvas>
    </div>

    <!-- Record Button -->
    <div class="record-section">
      <button class="record-btn" id="record-btn" onclick="toggleRecording()">üéôÔ∏è</button>
      <div class="record-status" id="record-status">PRESIONA PARA GRABAR</div>
    </div>
  </div>

  <!-- Playback -->
  <div class="section-title">Grabaciones</div>
  <div class="playback-section">
    <div class="no-recording" id="no-recording">No hay grabaciones a√∫n. ¬°Selecciona un personaje y graba!</div>
    <div id="recordings-list"></div>
  </div>

</div>

<script>
// =====================
//  CHARACTER PRESETS
// =====================
const defaultCharacters = [
  { id: 'robot', emoji: 'ü§ñ', name: 'Robot', tag: 'sint√©tico', pitch: 0, speed: 0.9, reverb: 20, distortion: 60, bass: 5, treble: -5 },
  { id: 'demon', emoji: 'üòà', name: 'Demonio', tag: 'oscuro', pitch: -10, speed: 0.8, reverb: 70, distortion: 80, bass: 15, treble: -10 },
  { id: 'alien', emoji: 'üëΩ', name: 'Alien√≠gena', tag: 'extra√±o', pitch: 7, speed: 1.2, reverb: 40, distortion: 30, bass: -5, treble: 10 },
  { id: 'giant', emoji: 'üèîÔ∏è', name: 'Gigante', tag: 'profundo', pitch: -8, speed: 0.75, reverb: 50, distortion: 20, bass: 18, treble: -8 },
  { id: 'chipmunk', emoji: 'üêøÔ∏è', name: 'Ardilla', tag: 'agudo', pitch: 11, speed: 1.5, reverb: 10, distortion: 0, bass: -10, treble: 15 },
  { id: 'ghost', emoji: 'üëª', name: 'Fantasma', tag: 'et√©reo', pitch: 4, speed: 0.95, reverb: 90, distortion: 10, bass: -5, treble: 5 },
  { id: 'dragon', emoji: 'üêâ', name: 'Drag√≥n', tag: '√©pico', pitch: -6, speed: 0.85, reverb: 60, distortion: 40, bass: 12, treble: -5 },
  { id: 'baby', emoji: 'üë∂', name: 'Beb√©', tag: 'infantil', pitch: 9, speed: 0.9, reverb: 15, distortion: 0, bass: -8, treble: 8 },
  { id: 'cyborg', emoji: 'ü¶æ', name: 'Cyborg', tag: 'h√≠brido', pitch: 2, speed: 1.05, reverb: 30, distortion: 45, bass: 8, treble: 3 },
  { id: 'witch', emoji: 'üßô‚Äç‚ôÄÔ∏è', name: 'Bruja', tag: 'm√≠stico', pitch: -3, speed: 0.9, reverb: 55, distortion: 25, bass: 5, treble: -3 },
  { id: 'angel', emoji: 'üòá', name: '√Ångel', tag: 'celestial', pitch: 5, speed: 1.1, reverb: 80, distortion: 0, bass: -8, treble: 10 },
  { id: 'zombie', emoji: 'üßü', name: 'Zombie', tag: 'lento', pitch: -5, speed: 0.65, reverb: 35, distortion: 55, bass: 10, treble: -12 },
];

let characters = [...defaultCharacters];
let selectedChar = null;
let isRecording = false;
let mediaRecorder = null;
let audioCtx = null;
let analyserNode = null;
let recordingChunks = [];
let recordings = [];
let animFrameId = null;
let sourceNode = null;
let processorNodes = [];

// =====================
//  RENDER CHARACTERS
// =====================
function renderCharacters() {
  const grid = document.getElementById('characters-grid');
  grid.innerHTML = '';
  characters.forEach((char, idx) => {
    const card = document.createElement('div');
    card.className = 'character-card' + (selectedChar && selectedChar.id === char.id ? ' active' : '');
    card.innerHTML = `
      <div class="active-indicator"></div>
      <span class="char-emoji">${char.emoji}</span>
      <div class="char-name">${char.name}</div>
      <span class="char-tag">${char.tag || 'personalizado'}</span>
    `;
    card.onclick = () => selectCharacter(char);
    grid.appendChild(card);
  });
}

function selectCharacter(char) {
  selectedChar = char;
  document.getElementById('pitch').value = char.pitch;
  document.getElementById('speed').value = char.speed;
  document.getElementById('reverb').value = char.reverb;
  document.getElementById('distortion').value = char.distortion;
  document.getElementById('bass').value = char.bass;
  document.getElementById('treble').value = char.treble;
  updateAllDisplays();
  document.getElementById('current-char-name').textContent = `${char.emoji} ${char.name}`;
  document.querySelector('.badge').textContent = 'ACTIVO';
  renderCharacters();
}

function updateAllDisplays() {
  updateSlider(document.getElementById('pitch'), 'pitch-val');
  updateSlider(document.getElementById('speed'), 'speed-val', true);
  updateSlider(document.getElementById('reverb'), 'reverb-val', false, true);
  updateSlider(document.getElementById('distortion'), 'distortion-val', false, true);
  updateSlider(document.getElementById('bass'), 'bass-val', false, false, true);
  updateSlider(document.getElementById('treble'), 'treble-val', false, false, true);
}

function updateSlider(el, displayId, isSpeed, isPercent, isDec) {
  const val = parseFloat(el.value);
  const disp = document.getElementById(displayId);
  if (isSpeed) disp.textContent = val.toFixed(2) + 'x';
  else if (isPercent) disp.textContent = Math.round(val) + '%';
  else if (isDec) disp.textContent = val + 'dB';
  else disp.textContent = val;

  const min = parseFloat(el.min), max = parseFloat(el.max);
  const pct = ((val - min) / (max - min)) * 100;
  el.style.setProperty('--progress', pct + '%');
}

// =====================
//  CUSTOM CHARACTER
// =====================
function addCustomCharacter() {
  const emoji = document.getElementById('custom-emoji').value.trim() || 'üé≠';
  const name = document.getElementById('custom-name').value.trim();
  if (!name) { alert('Por favor ingresa un nombre para el personaje.'); return; }

  const pitch = parseFloat(document.getElementById('pitch').value);
  const speed = parseFloat(document.getElementById('speed').value);
  const reverb = parseFloat(document.getElementById('reverb').value);
  const distortion = parseFloat(document.getElementById('distortion').value);
  const bass = parseFloat(document.getElementById('bass').value);
  const treble = parseFloat(document.getElementById('treble').value);

  const newChar = {
    id: 'custom_' + Date.now(),
    emoji, name, tag: 'personalizado',
    pitch, speed, reverb, distortion, bass, treble
  };
  characters.push(newChar);
  selectCharacter(newChar);
  document.getElementById('custom-emoji').value = '';
  document.getElementById('custom-name').value = '';
}

// =====================
//  AUDIO ENGINE
// =====================
async function setupAudioContext() {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  if (audioCtx.state === 'suspended') await audioCtx.resume();
}

function buildAudioGraph(stream) {
  // Cleanup old
  processorNodes.forEach(n => { try { n.disconnect(); } catch(e) {} });
  processorNodes = [];

  const pitch = parseFloat(document.getElementById('pitch').value);
  const speed = parseFloat(document.getElementById('speed').value);
  const reverb = parseFloat(document.getElementById('reverb').value) / 100;
  const distortion = parseFloat(document.getElementById('distortion').value) / 100;
  const bass = parseFloat(document.getElementById('bass').value);
  const treble = parseFloat(document.getElementById('treble').value);

  const source = audioCtx.createMediaStreamSource(stream);
  sourceNode = source;

  // EQ - Bass
  const bassFilter = audioCtx.createBiquadFilter();
  bassFilter.type = 'lowshelf';
  bassFilter.frequency.value = 200;
  bassFilter.gain.value = bass;

  // EQ - Treble
  const trebleFilter = audioCtx.createBiquadFilter();
  trebleFilter.type = 'highshelf';
  trebleFilter.frequency.value = 4000;
  trebleFilter.gain.value = treble;

  // Distortion
  const waveshaper = audioCtx.createWaveShaper();
  waveshaper.curve = makeDistortionCurve(distortion * 400);
  waveshaper.oversample = '4x';

  // Analyser for visualizer
  analyserNode = audioCtx.createAnalyser();
  analyserNode.fftSize = 256;

  // Reverb (simple delay-based)
  const convolver = audioCtx.createConvolver();
  const reverbWet = audioCtx.createGain();
  const reverbDry = audioCtx.createGain();
  reverbWet.gain.value = reverb;
  reverbDry.gain.value = 1 - reverb * 0.5;
  convolver.buffer = createReverbBuffer(audioCtx, 2, 44100);

  // Pitch via detune on a buffer source trick
  const pitchShift = audioCtx.createBiquadFilter();
  pitchShift.type = 'allpass';
  pitchShift.frequency.value = 440;
  pitchShift.Q.value = pitch * 0.5;

  // Chain: source ‚Üí bass ‚Üí treble ‚Üí waveshaper ‚Üí analyser ‚Üí dry/wet ‚Üí dest
  source.connect(bassFilter);
  bassFilter.connect(trebleFilter);
  trebleFilter.connect(waveshaper);
  waveshaper.connect(analyserNode);
  analyserNode.connect(reverbDry);
  analyserNode.connect(convolver);
  convolver.connect(reverbWet);

  const merger = audioCtx.createGain();
  reverbDry.connect(merger);
  reverbWet.connect(merger);

  // Destination for recording
  const dest = audioCtx.createMediaStreamDestination();
  merger.connect(dest);

  processorNodes = [bassFilter, trebleFilter, waveshaper, analyserNode, reverbDry, reverbWet, convolver, merger, pitchShift];

  return { processedStream: dest.stream };
}

function makeDistortionCurve(amount) {
  const samples = 256;
  const curve = new Float32Array(samples);
  const deg = Math.PI / 180;
  for (let i = 0; i < samples; i++) {
    const x = (i * 2) / samples - 1;
    curve[i] = ((3 + amount) * x * 20 * deg) / (Math.PI + amount * Math.abs(x));
  }
  return curve;
}

function createReverbBuffer(ctx, duration, sampleRate) {
  const len = ctx.sampleRate * duration;
  const buffer = ctx.createBuffer(2, len, ctx.sampleRate);
  for (let ch = 0; ch < 2; ch++) {
    const data = buffer.getChannelData(ch);
    for (let i = 0; i < len; i++) {
      data[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / len, 2);
    }
  }
  return buffer;
}

// =====================
//  VISUALIZER
// =====================
function startVisualizer() {
  const canvas = document.getElementById('visualizer');
  const ctx = canvas.getContext('2d');
  canvas.width = canvas.offsetWidth;
  canvas.height = canvas.offsetHeight;

  function draw() {
    animFrameId = requestAnimationFrame(draw);
    if (!analyserNode) {
      ctx.fillStyle = 'transparent';
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawIdleWave(ctx, canvas);
      return;
    }
    const bufferLen = analyserNode.frequencyBinCount;
    const dataArray = new Uint8Array(bufferLen);
    analyserNode.getByteTimeDomainData(dataArray);
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.lineWidth = 2;
    ctx.strokeStyle = isRecording ? '#ff3a7c' : '#7c3aff';
    ctx.shadowColor = isRecording ? '#ff3a7c' : '#7c3aff';
    ctx.shadowBlur = 8;
    ctx.beginPath();
    const sliceWidth = canvas.width / bufferLen;
    let x = 0;
    for (let i = 0; i < bufferLen; i++) {
      const v = dataArray[i] / 128.0;
      const y = (v * canvas.height) / 2;
      if (i === 0) ctx.moveTo(x, y);
      else ctx.lineTo(x, y);
      x += sliceWidth;
    }
    ctx.lineTo(canvas.width, canvas.height / 2);
    ctx.stroke();
  }
  draw();
}

function drawIdleWave(ctx, canvas) {
  const t = Date.now() / 1000;
  ctx.lineWidth = 1.5;
  ctx.strokeStyle = 'rgba(124,58,255,0.3)';
  ctx.shadowColor = 'rgba(124,58,255,0.3)';
  ctx.shadowBlur = 4;
  ctx.beginPath();
  for (let x = 0; x < canvas.width; x++) {
    const y = canvas.height / 2 + Math.sin((x / canvas.width) * Math.PI * 4 + t * 2) * 8;
    x === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  }
  ctx.stroke();
}

// =====================
//  RECORD
// =====================
async function toggleRecording() {
  if (isRecording) {
    stopRecording();
  } else {
    await startRecording();
  }
}

async function startRecording() {
  if (!selectedChar) {
    alert('¬°Selecciona un personaje primero!');
    return;
  }
  try {
    await setupAudioContext();
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    const { processedStream } = buildAudioGraph(stream);

    recordingChunks = [];
    mediaRecorder = new MediaRecorder(processedStream);
    mediaRecorder.ondataavailable = e => { if (e.data.size > 0) recordingChunks.push(e.data); };
    mediaRecorder.onstop = () => saveRecording(stream);
    mediaRecorder.start(100);

    isRecording = true;
    document.getElementById('record-btn').classList.add('recording');
    document.getElementById('record-btn').textContent = '‚èπÔ∏è';
    document.getElementById('record-status').textContent = 'GRABANDO... PRESIONA PARA DETENER';
    document.getElementById('record-status').classList.add('active');

  } catch (err) {
    console.error(err);
    alert('Error accediendo al micr√≥fono: ' + err.message);
  }
}

function stopRecording() {
  if (mediaRecorder && mediaRecorder.state !== 'inactive') {
    mediaRecorder.stop();
  }
  isRecording = false;
  document.getElementById('record-btn').classList.remove('recording');
  document.getElementById('record-btn').textContent = 'üéôÔ∏è';
  document.getElementById('record-status').textContent = 'PRESIONA PARA GRABAR';
  document.getElementById('record-status').classList.remove('active');
}

function saveRecording(originalStream) {
  originalStream.getTracks().forEach(t => t.stop());

  const blob = new Blob(recordingChunks, { type: 'audio/webm' });
  const url = URL.createObjectURL(blob);
  const rec = {
    id: Date.now(),
    url,
    blob,
    charName: selectedChar.name,
    charEmoji: selectedChar.emoji,
    name: `Grabaci√≥n #${recordings.length + 1}`,
    time: new Date().toLocaleTimeString('es', {hour:'2-digit', minute:'2-digit'})
  };
  recordings.push(rec);
  renderRecordings();
}

// =====================
//  RECORDINGS LIST
// =====================
function renderRecordings() {
  const list = document.getElementById('recordings-list');
  const noRec = document.getElementById('no-recording');
  if (recordings.length === 0) {
    noRec.style.display = 'block';
    list.innerHTML = '';
    return;
  }
  noRec.style.display = 'none';
  list.innerHTML = '';
  recordings.slice().reverse().forEach(rec => {
    const item = document.createElement('div');
    item.className = 'recording-item';
    item.innerHTML = `
      <div style="font-size:1.8rem">${rec.charEmoji}</div>
      <div class="recording-info">
        <div class="recording-name">${rec.name}</div>
        <div class="recording-char">${rec.charName} ¬∑ ${rec.time}</div>
        <audio controls src="${rec.url}" style="margin-top:8px; width:100%; height:28px; filter: hue-rotate(230deg);"></audio>
      </div>
      <a class="dl-btn" href="${rec.url}" download="voxshift_${rec.charName.toLowerCase()}_${rec.id}.webm" title="Descargar">‚¨á</a>
      <button class="del-btn" onclick="deleteRecording(${rec.id})" title="Eliminar">‚úï</button>
    `;
    list.appendChild(item);
  });
}

function deleteRecording(id) {
  const idx = recordings.findIndex(r => r.id === id);
  if (idx !== -1) {
    URL.revokeObjectURL(recordings[idx].url);
    recordings.splice(idx, 1);
    renderRecordings();
  }
}

// =====================
//  INIT
// =====================
renderCharacters();
updateAllDisplays();
startVisualizer();

// Resize visualizer
window.addEventListener('resize', () => {
  const canvas = document.getElementById('visualizer');
  canvas.width = canvas.offsetWidth;
  canvas.height = canvas.offsetHeight;
});
</script>
</body>
</html>